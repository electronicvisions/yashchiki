pipeline {
	agent { label 'conviz' }

	stages {
		stage('Clone') {
			steps {
				sh ".ci/clone.sh"
			}
		}
		stage('Create visionary Recipe') {
			steps {
				sh ".ci/create_visionary_recipe.sh"
			}
		}
		stage('Build Container') {
			steps {
				sh ".ci/build_container.sh"
			}
		}
		stage('Update Build Cache') {
			steps {
				sh ".ci/update_build_cache.sh"
			}
		}
		stage('Export') {
			steps {
				sh ".ci/deploy_container.sh"
				echo "TODO skipping (due to disk usage problems on jenviz): archiveArtifacts artifacts: '*.img', onlyIfSuccessful: true"
			}
		}
	}

	post {
		cleanup {
			sh ".ci/remove_sandboxes.sh"
			sh ".ci/remove_tmp_spack.sh"
			sh ".ci/remove_ccache.sh"
			cleanWs(patterns: [[pattern: 'ccache/', type: 'EXCLUDE'],
			                  [pattern: 'download_cache/', type: 'EXCLUDE']],
			        deleteDirs: true)
		}
	}
}
