Closure cleanupSteps = {
	sh ".ci/remove_sandboxes.sh"
	sh ".ci/remove_tmp_spack.sh"
	sh ".ci/remove_ccache.sh"
	cleanWs(patterns: [[pattern: 'ccache/', type: 'EXCLUDE'],
	                   [pattern: 'download_cache/', type: 'EXCLUDE']],
	        deleteDirs: true)
}

pipeline {
	agent { label 'conviz' }
	environment {
		/* FIXME: ^${DEPENDENCY_PYTHON} is a workaround for an invalid spectrum-mpi concretization */
		DEPENDENCY_PYTHON="python@2.7.15"
		VISIONARY_GCC_VERSION="8.2.0"
		VISIONARY_GCC="gcc@8.2.0"
	}
	stages {
		stage('Validate environment') {
			steps {
				sh ".ci/validate_environment.sh"
			}
		}
		stage('Pre-build Cleanup') {
			steps {
				script {
					cleanupSteps()
				}
			}
		}
		stage('Clone') {
			steps {
				checkout scm
				sh ".ci/clone.sh"
			}
		}
		stage('Deploy utilities')
		{
			steps {
				sh ".ci/deploy_utilities.sh"
			}
		}
		stage('Create visionary Recipe') {
			steps {
				sh ".ci/create_visionary_recipe.sh"
			}
		}
		stage('Build Container') {
			steps {
				sh ".ci/build_container.sh"
			}
		}
		stage('Update Build Cache') {
			steps {
				sh ".ci/update_build_cache.sh"
			}
		}
		stage('Export') {
			steps {
				sh ".ci/deploy_container.sh"
				echo "TODO skipping (due to disk usage problems on jenviz): archiveArtifacts artifacts: '*.img', onlyIfSuccessful: true"
			}
		}
	}

	post {
		cleanup {
			script {
				cleanupSteps()
			}
		}
	}
}
